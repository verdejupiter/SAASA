<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            saasa: {50:'#eff6ff',100:'#dbeafe',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',800:'#1e3a5f',900:'#0f172a'}
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .spinner { border:4px solid #e5e7eb; border-top:4px solid #2563eb; border-radius:50%; width:48px; height:48px; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @keyframes countUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    .animate-count { animation: countUp 0.4s ease-out; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- HEADER -->
  <header class="bg-gradient-to-r from-saasa-900 to-saasa-800 text-white px-6 py-5 shadow-lg">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">SAASA - Control de Asistencia</h1>
        <p class="text-sm text-blue-200 mt-1">Servicios Aeroportuarios Andinos S.A.</p>
      </div>
      <div class="text-right">
        <div class="text-xs text-blue-200" id="txtActualizacion">Cargando...</div>
        <div class="text-xs text-blue-200" id="txtTotalUsuarios"></div>
        <div class="text-xs text-blue-300 font-medium mt-1" id="txtFuente"></div>
      </div>
    </div>
  </header>

  <!-- FILTROS -->
  <div class="bg-white border-b border-gray-200 px-6 py-4">
    <div class="max-w-7xl mx-auto flex flex-wrap gap-3 items-center">
      <label class="text-sm font-medium text-gray-500">Desde:</label>
      <input type="date" id="fechaDesde" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-saasa-500">
      <label class="text-sm font-medium text-gray-500">Hasta:</label>
      <input type="date" id="fechaHasta" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-saasa-500">
      <button onclick="cargarDatos()" id="btnConsultar" class="bg-saasa-600 hover:bg-saasa-700 text-white font-semibold px-5 py-2 rounded-lg text-sm transition-colors">
        Sincronizar API
      </button>
      <button onclick="cargarDesdeDB()" id="btnDesdeDB" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-5 py-2 rounded-lg text-sm transition-colors">
        Cargar desde BD
      </button>
      <button onclick="exportarCSV()" id="btnExportar" class="bg-gray-600 hover:bg-gray-700 text-white font-medium px-4 py-2 rounded-lg text-sm transition-colors hidden">
        Exportar CSV
      </button>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="max-w-7xl mx-auto px-6 py-6">

    <!-- CARDS RESUMEN -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm p-5 text-center border-t-4 border-saasa-500">
        <div class="text-3xl font-bold text-saasa-600 animate-count" id="numProgramados">-</div>
        <div class="text-xs text-gray-500 mt-1 font-medium">Programados</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 text-center border-t-4 border-emerald-500">
        <div class="text-3xl font-bold text-emerald-600 animate-count" id="numAsistieron">-</div>
        <div class="text-xs text-gray-500 mt-1 font-medium">Asistieron</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 text-center border-t-4 border-red-500">
        <div class="text-3xl font-bold text-red-600 animate-count" id="numFaltaron">-</div>
        <div class="text-xs text-gray-500 mt-1 font-medium">Faltas</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 text-center border-t-4 border-amber-400">
        <div class="text-3xl font-bold text-amber-500 animate-count" id="numPendientes">-</div>
        <div class="text-xs text-gray-500 mt-1 font-medium">Pendientes</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 text-center border-t-4 border-violet-500 col-span-2 md:col-span-1">
        <div class="text-3xl font-bold text-violet-600 animate-count" id="numPorcentaje">-%</div>
        <div class="text-xs text-gray-500 mt-1 font-medium">% Asistencia</div>
      </div>
    </div>

    <!-- BARRA DE PROGRESO + GRÁFICO -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm p-5 md:col-span-2">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-semibold text-gray-700">Porcentaje de Asistencia</span>
          <span class="text-sm font-bold" id="txtBarraPct">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden">
          <div id="barraProgreso" class="h-5 rounded-full transition-all duration-700 ease-out flex items-center justify-center text-xs font-bold text-white" style="width:0%; background:#059669;"></div>
        </div>
        <div class="flex justify-between mt-3 text-xs text-gray-400">
          <span>0%</span>
          <span class="text-red-400 font-medium">60% min</span>
          <span class="text-amber-400 font-medium">80% meta</span>
          <span>100%</span>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-5 flex items-center justify-center">
        <canvas id="chartTorta" width="180" height="180"></canvas>
      </div>
    </div>

    <!-- TABS DE DÍAS -->
    <div class="flex flex-wrap gap-2 mb-4" id="tabsDias"></div>

    <!-- BUSCADOR -->
    <div class="flex flex-wrap gap-3 items-center mb-4">
      <input type="text" id="inputBuscar" placeholder="Buscar por nombre..." oninput="filtrarTabla()"
        class="flex-1 min-w-[200px] md:max-w-sm border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-saasa-500">
      <span class="text-xs text-gray-400" id="txtContador"></span>
    </div>

    <!-- TABLA DETALLE -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="bg-saasa-800 text-white">
              <th class="px-4 py-3 text-left text-xs font-semibold w-10">#</th>
              <th class="px-4 py-3 text-left text-xs font-semibold">Nombre</th>
              <th class="px-4 py-3 text-left text-xs font-semibold">Turno</th>
              <th class="px-4 py-3 text-center text-xs font-semibold">Entrada</th>
              <th class="px-4 py-3 text-center text-xs font-semibold">Salida</th>
              <th class="px-4 py-3 text-center text-xs font-semibold">Hrs Trab.</th>
              <th class="px-4 py-3 text-center text-xs font-semibold">Estado</th>
            </tr>
          </thead>
          <tbody id="tablaBody">
            <tr>
              <td colspan="7" class="text-center py-16 text-gray-400">
                <div class="text-3xl mb-3">&#128203;</div>
                <div class="text-sm font-medium">Selecciona las fechas y presiona un botón</div>
                <div class="text-xs mt-2">
                  <span class="text-saasa-600 font-semibold">Sincronizar API</span> = datos frescos desde GeoVictoria |
                  <span class="text-emerald-600 font-semibold">Cargar desde BD</span> = datos guardados (rápido)
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="text-center py-6 text-xs text-gray-400">
    SAASA - Control de Asistencia | Servicios Aeroportuarios Andinos S.A.
  </footer>

  <!-- OVERLAY DE CARGA -->
  <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 hidden items-center justify-center flex-col">
    <div class="spinner"></div>
    <p class="mt-4 text-sm text-gray-600 font-medium">Consultando datos de asistencia...</p>
    <p class="mt-1 text-xs text-gray-400">Procesando usuarios en lotes de 50</p>
  </div>

  <!-- ══════════════════════════════════════════════════════════════════════ -->
  <!-- JAVASCRIPT DEL CLIENTE (Frontend)                                     -->
  <!-- Comunicación con el backend: google.script.run                        -->
  <!-- ══════════════════════════════════════════════════════════════════════ -->
  <script>
    // ── Estado Global ──
    var datosGlobal = null;
    var diaSeleccionado = null;
    var chartTorta = null;

    // Prioridad para ordenar la tabla (faltas primero = más urgente)
    var PRIORIDAD = { "Faltó":5, "Pendiente":4, "Sin salida":3, "Asistió":2, "Día Libre":1 };

    // Colores de los badges de estado
    var COLORES_BADGE = {
      "Asistió":    "bg-emerald-100 text-emerald-700",
      "Faltó":      "bg-red-100 text-red-700",
      "Pendiente":  "bg-amber-100 text-amber-700",
      "Sin salida": "bg-orange-100 text-orange-700",
      "Día Libre":  "bg-gray-100 text-gray-500"
    };

    // Días de la semana en español
    var DIAS_SEMANA = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];


    // ── Inicialización ──
    // Pone fechas por defecto (ayer y hoy) sin cargar automáticamente.
    // El usuario elige: "Sincronizar API" (trae datos frescos) o "Cargar desde BD" (rápido).
    (function() {
      var hoy  = new Date();
      var ayer = new Date(hoy.getTime() - 86400000);
      document.getElementById("fechaDesde").value = fmtDate(ayer);
      document.getElementById("fechaHasta").value = fmtDate(hoy);
    })();

    function fmtDate(d) {
      return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate());
    }

    function pad(n) { return ("0" + n).slice(-2); }


    // ── Cargar Datos desde Backend ──
    function cargarDatos() {
      var desde = document.getElementById("fechaDesde").value;
      var hasta = document.getElementById("fechaHasta").value;
      if (!desde || !hasta) { alert("Selecciona ambas fechas"); return; }

      toggleLoading(true, "Sincronizando con GeoVictoria...", "Procesando usuarios en lotes de 50");
      document.getElementById("btnConsultar").disabled = true;

      google.script.run
        .withSuccessHandler(function(datos) {
          toggleLoading(false);
          document.getElementById("btnConsultar").disabled = false;
          if (datos.error) { mostrarError(datos.mensaje); return; }
          datosGlobal = datos;
          renderDashboard();
        })
        .withFailureHandler(function(err) {
          toggleLoading(false);
          document.getElementById("btnConsultar").disabled = false;
          mostrarError("Error de conexión: " + err.message);
        })
        .obtenerDatosDashboard(desde, hasta);
    }


    // ── Cargar desde Base de Datos (sin llamar a GeoVictoria) ──
    function cargarDesdeDB() {
      var desde = document.getElementById("fechaDesde").value;
      var hasta = document.getElementById("fechaHasta").value;
      if (!desde || !hasta) { alert("Selecciona ambas fechas"); return; }

      toggleLoading(true, "Consultando base de datos...", "Cargando desde Azure MySQL");
      document.getElementById("btnDesdeDB").disabled = true;

      google.script.run
        .withSuccessHandler(function(datos) {
          toggleLoading(false);
          document.getElementById("btnDesdeDB").disabled = false;
          if (datos.error) { mostrarError(datos.mensaje); return; }
          datosGlobal = datos;
          renderDashboard();
        })
        .withFailureHandler(function(err) {
          toggleLoading(false);
          document.getElementById("btnDesdeDB").disabled = false;
          mostrarError("Error de conexión BD: " + err.message);
        })
        .obtenerDatosDesdeSQL(desde, hasta);
    }


    // ── Render Principal ──
    function renderDashboard() {
      if (!datosGlobal || !datosGlobal.resumenPorDia.length) {
        mostrarError("No hay datos para las fechas seleccionadas");
        return;
      }

      document.getElementById("txtActualizacion").textContent = "Actualizado: " + datosGlobal.fechaActualizacion;
      document.getElementById("txtTotalUsuarios").textContent = datosGlobal.totalUsuarios + " usuarios registrados";
      document.getElementById("txtFuente").textContent = datosGlobal.fuenteDatos || "";
      document.getElementById("btnExportar").classList.remove("hidden");

      renderTabs();
      diaSeleccionado = datosGlobal.resumenPorDia[0].fecha;
      actualizarDia();
    }


    // ── Tabs por Día ──
    function renderTabs() {
      var html = "";
      for (var i = 0; i < datosGlobal.resumenPorDia.length; i++) {
        var d = datosGlobal.resumenPorDia[i];
        var p = d.fecha.split("-");
        var dateObj = new Date(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2]));
        var label = DIAS_SEMANA[dateObj.getDay()] + " " + p[2] + "/" + p[1];

        html += '<button onclick="seleccionarDia(\'' + d.fecha + '\')" id="tab-' + d.fecha + '" ' +
          'class="px-4 py-2 rounded-lg text-sm font-medium border-2 border-gray-200 bg-white hover:border-saasa-500 transition-colors">' +
          label + ' <span class="text-xs font-bold opacity-70">(' + d.porcentaje + '%)</span></button>';
      }
      document.getElementById("tabsDias").innerHTML = html;
    }

    function seleccionarDia(fecha) {
      diaSeleccionado = fecha;
      actualizarDia();
    }


    // ── Actualizar Vista del Día Seleccionado ──
    function actualizarDia() {
      var r = datosGlobal.resumenPorDia.find(function(x) { return x.fecha === diaSeleccionado; });
      if (!r) return;

      // Cards numéricas
      animarNumero("numProgramados", r.programados);
      animarNumero("numAsistieron", r.asistieron);
      animarNumero("numFaltaron", r.faltaron);
      animarNumero("numPendientes", r.pendientes);
      animarNumero("numPorcentaje", r.porcentaje + "%");

      // Barra de progreso con semáforo (verde ≥80%, amarillo ≥60%, rojo <60%)
      var barra = document.getElementById("barraProgreso");
      barra.style.width = r.porcentaje + "%";
      barra.textContent = r.porcentaje > 10 ? r.porcentaje + "%" : "";
      barra.style.background = r.porcentaje >= 80 ? "#059669" : r.porcentaje >= 60 ? "#d97706" : "#dc2626";
      document.getElementById("txtBarraPct").textContent = r.porcentaje + "%";

      // Tab activo
      document.querySelectorAll("#tabsDias button").forEach(function(t) {
        t.classList.remove("border-saasa-600","bg-saasa-600","text-white");
        t.classList.add("border-gray-200","bg-white");
      });
      var activo = document.getElementById("tab-" + diaSeleccionado);
      if (activo) {
        activo.classList.remove("border-gray-200","bg-white");
        activo.classList.add("border-saasa-600","bg-saasa-600","text-white");
      }

      renderChart(r);
      renderTabla();
    }

    function animarNumero(id, valor) {
      var el = document.getElementById(id);
      el.textContent = valor;
      el.classList.remove("animate-count");
      void el.offsetWidth;
      el.classList.add("animate-count");
    }


    // ── Gráfico Doughnut (Chart.js) ──
    function renderChart(resumen) {
      var ctx = document.getElementById("chartTorta").getContext("2d");
      if (chartTorta) chartTorta.destroy();

      chartTorta = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Asistieron", "Faltas", "Pendientes"],
          datasets: [{
            data: [resumen.asistieron, resumen.faltaron, resumen.pendientes],
            backgroundColor: ["#059669", "#dc2626", "#d97706"],
            borderWidth: 0, hoverOffset: 6
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: true, cutout: "60%",
          plugins: { legend: { position: "bottom", labels: { font: { size: 11, family: "Inter" }, padding: 12 } } }
        }
      });
    }


    // ── Tabla de Detalle ──
    function renderTabla() {
      var empleados = datosGlobal.detallePorDia[diaSeleccionado];
      if (!empleados || !empleados.length) {
        document.getElementById("tablaBody").innerHTML = '<tr><td colspan="7" class="text-center py-12 text-gray-400 text-sm">Sin registros</td></tr>';
        document.getElementById("txtContador").textContent = "";
        return;
      }

      // Ordenar: faltas primero (prioridad más alta = más urgente)
      var ordenados = empleados.slice().sort(function(a, b) {
        var diff = (PRIORIDAD[b.estado] || 0) - (PRIORIDAD[a.estado] || 0);
        return diff !== 0 ? diff : a.nombre.localeCompare(b.nombre);
      });

      var busqueda = document.getElementById("inputBuscar").value.toLowerCase();
      var html = "";
      var num = 0;

      for (var i = 0; i < ordenados.length; i++) {
        var e = ordenados[i];
        if (busqueda && e.nombre.toLowerCase().indexOf(busqueda) === -1) continue;
        num++;

        html += '<tr class="' + (num % 2 === 0 ? "bg-gray-50" : "bg-white") + ' hover:bg-blue-50 transition-colors">' +
          '<td class="px-4 py-3 text-xs text-gray-400">' + num + '</td>' +
          '<td class="px-4 py-3 text-sm font-medium text-gray-900">' + e.nombre + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-600">' + e.turnoNombre + '</td>' +
          '<td class="px-4 py-3 text-sm font-mono text-center ' + (e.horaEntrada !== "-" ? "text-gray-900" : "text-gray-300") + '">' + e.horaEntrada + '</td>' +
          '<td class="px-4 py-3 text-sm font-mono text-center ' + (e.horaSalida !== "-" ? "text-gray-900" : "text-gray-300") + '">' + e.horaSalida + '</td>' +
          '<td class="px-4 py-3 text-sm font-mono text-center text-gray-600">' + e.horasTrabajadas + '</td>' +
          '<td class="px-4 py-3 text-center"><span class="inline-block px-2.5 py-1 rounded-full text-xs font-semibold ' +
          (COLORES_BADGE[e.estado] || "bg-gray-100 text-gray-500") + '">' + e.estado + '</span></td></tr>';
      }

      document.getElementById("tablaBody").innerHTML = html;
      document.getElementById("txtContador").textContent = num + " de " + ordenados.length + " empleados";
    }


    // ── Filtrar Tabla por Nombre ──
    function filtrarTabla() { renderTabla(); }


    // ── Exportar CSV ──
    function exportarCSV() {
      if (!datosGlobal || !diaSeleccionado) return;
      var empleados = datosGlobal.detallePorDia[diaSeleccionado];
      if (!empleados) return;

      var csv = "Nombre,Turno,Entrada,Salida,Horas,Estado\n";
      for (var i = 0; i < empleados.length; i++) {
        var e = empleados[i];
        csv += '"' + e.nombre + '","' + e.turnoNombre + '",' + e.horaEntrada + ',' +
               e.horaSalida + ',' + e.horasTrabajadas + ',' + e.estado + '\n';
      }

      var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      var link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "asistencia_" + diaSeleccionado + ".csv";
      link.click();
    }


    // ── Mostrar/Ocultar Loading ──
    function toggleLoading(show, titulo, subtitulo) {
      var el = document.getElementById("loading");
      if (show && titulo) {
        el.querySelector("p").textContent = titulo;
        el.querySelectorAll("p")[1].textContent = subtitulo || "";
      }
      el.classList.toggle("hidden", !show);
      el.classList.toggle("flex", show);
    }

    function mostrarError(msg) {
      document.getElementById("tablaBody").innerHTML =
        '<tr><td colspan="7" class="text-center py-16 text-red-400">' +
        '<div class="text-3xl mb-3">&#9888;</div>' +
        '<div class="text-sm">' + msg + '</div>' +
        '<div class="text-xs mt-2 text-gray-400">Intenta con otro rango de fechas</div></td></tr>';
    }
  </script>
</body>
</html>
